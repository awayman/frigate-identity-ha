name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate manifest version matches tag
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          MANIFEST_VERSION=$(python3 -c "import json; print(json.load(open('custom_components/frigate_identity/manifest.json'))['version'])")
          if [ "$TAG_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "::error::Tag version ($TAG_VERSION) does not match manifest.json version ($MANIFEST_VERSION)"
            exit 1
          fi

  release:
    name: Create Release
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create release zip
        run: |
          cd custom_components
          zip -r ../frigate_identity.zip frigate_identity/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: frigate_identity.zip
          draft: false
          prerelease: false
