# Frigate Identity â€“ Dashboard Setup & Further Automations

This guide covers the end-to-end flow: generating the configuration, wiring it
into Home Assistant, and setting up automations for yard safety monitoring.

---

## Part 1 â€“ Generate the Configuration Files

If you have a `persons.yaml` from the [Frigate Identity Service](https://github.com/awayman/frigate_identity_service), point the generator at it.

### With HA connection (recommended â€” produces area-grouped dashboard)

When `--ha-url` and `--ha-token` are supplied, the generator queries HA for the
Area of each camera and produces a dashboard **grouped by HA Area**:

```bash
pip install pyyaml
python examples/generate_dashboard.py \
    --persons-file /config/persons.yaml \
    --output /config/frigate_identity \
    --ha-url http://homeassistant.local:8123 \
    --ha-token YOUR_LONG_LIVED_ACCESS_TOKEN
```

The dashboard will look like:

```
ğŸ“ Frigate Identity â€“ Person Tracker

ğŸŒ³ Back Yard
  [camera.backyard live feed]  [camera.patio live feed]
  [Alice snapshot + status]    [Dad snapshot + status]  [Mom snapshot + status]

ğŸš— Front Entry
  [camera.front_door live feed]
  [Bob snapshot + status]

System Status
```

### Without HA connection (produces flat layout)

```bash
python examples/generate_dashboard.py \
    --persons-file /config/persons.yaml \
    --output /config/frigate_identity
```

Falls back to a flat list of person cards (no area grouping, no camera feeds).
Use `camera_zones` in `persons.yaml` to get area grouping without a live HA
connection â€” see [Part 4](#part-4--zone-model-for-large-yards).

The generator writes these files to `/config/frigate_identity/`:

| File | What it contains |
|---|---|
| `mqtt_cameras.yaml` | MQTT `camera` entities â€” one per person (bounded snapshot) |
| `template_sensors.yaml` | Per-person location sensors + supervision binary sensors |
| `dashboard.yaml` | Full Lovelace dashboard YAML (area-grouped when areas are known) |
| `danger_zone_automations.yaml` | Danger-zone automations *(only when children have `dangerous_zones`)* |

---

## Part 2 â€“ Automated One-Command Setup (Recommended)

If your HA `/config` directory is accessible (HA OS, Container, or SSH), you
can let the generator configure **everything** in a single command:

```bash
python examples/generate_dashboard.py \
    --persons-file /config/persons.yaml \
    --output /config/frigate_identity \
    --ha-config-dir /config \
    --ha-url http://homeassistant.local:8123 \
    --ha-token YOUR_LONG_LIVED_ACCESS_TOKEN \
    --copy-blueprints \
    --restart
```

What each flag does:

| Flag | What it automates |
|---|---|
| `--ha-config-dir /config` | Writes `packages/frigate_identity.yaml` (wires sensors/cameras/automations into HA). Patches `configuration.yaml` to enable packages if needed. |
| `--ha-url` + `--ha-token` | **Fetches camera Area assignments from HA**, produces an area-grouped dashboard, then pushes it directly via the HA REST API â€” no pasting required. |
| `--copy-blueprints` | Copies blueprint files to `/config/blueprints/automation/frigate_identity/`. |
| `--restart` | Triggers a Home Assistant restart after all changes. |

**Getting a long-lived access token:**
In HA â†’ Profile (bottom-left) â†’ Security tab â†’ Long-Lived Access Tokens â†’ Create.

After the restart, the Frigate Identity view is live at `/lovelace/frigate-identity`.

### Re-running after changes

When you update `persons.yaml` (add/remove a person), just re-run:

```bash
python examples/generate_dashboard.py \
    --persons-file /config/persons.yaml \
    --output /config/frigate_identity \
    --ha-config-dir /config \
    --ha-url http://homeassistant.local:8123 \
    --ha-token YOUR_TOKEN \
    --restart
```

The package file and dashboard are overwritten in-place; `configuration.yaml`
is not touched again once packages are already enabled.

---

## Part 3 â€“ Manual Setup (Alternative)

Use this path if your HA config directory is not directly accessible.

### 3a. Wire files into configuration.yaml

Add `!include` directives to `/config/configuration.yaml`:

```yaml
mqtt:
  camera: !include frigate_identity/mqtt_cameras.yaml

template: !include frigate_identity/template_sensors.yaml

automation: !include frigate_identity/danger_zone_automations.yaml
```

> **Tip â€” use HA packages instead:** Add a single `homeassistant: packages:
> !include_dir_named packages` line once, then drop
> `packages/frigate_identity.yaml` (generated by `--ha-config-dir`) alongside
> it. Future re-runs only update that one package file â€” no further edits to
> `configuration.yaml` ever needed.

Restart Home Assistant.

### 3b. Create the Lovelace dashboard

1. **Settings â†’ Dashboards â†’ + Add dashboard**
2. Title: `Frigate Identity` / Icon: `mdi:account-search`
3. Open the new dashboard â†’ **Edit âœï¸** â†’ **â‹® menu â†’ Raw configuration editor**
4. Select all existing content, replace with the contents of `dashboard.yaml`, click **Save**

---

## Part 4 â€“ Zone Model for Large Yards

For a child playing in a large yard covered by multiple cameras, safety
monitoring uses **two different zone concepts** that serve distinct purposes.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 1 â€“ Frigate camera zones  (per-camera pixel regions)      â”‚
â”‚  Purpose: WHERE is the child within the camera view?             â”‚
â”‚  Set in:  persons.yaml  dangerous_zones                          â”‚
â”‚  Used in: danger_zone_automations.yaml  (location trigger)       â”‚
â”‚  Example: "near_fence", "outside_gate" on camera_backyard        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Level 2 â€“ HA Areas  (Settings â†’ Areas & Zones in HA)            â”‚
â”‚  Purpose: Is an adult in the same PHYSICAL area as the child?    â”‚
â”‚  Set in:  Home Assistant UI â€“ assign cameras to Areas            â”‚
â”‚  Used in: binary_sensor.<child>_supervised  (via area_name())    â”‚
â”‚  Example: cameras "backyard" and "patio" both in Area "Back Yard"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“ combined â†“
    Alert when child is in a dangerous Frigate zone  AND  unsupervised
```

### Level 1 â€“ Frigate camera zones: dangerous location detection

Frigate zones are **pixel-region annotations on a single camera**.  They are
the right tool for detecting *where within a camera view* a child is.

For example, on `camera_backyard` you might define:

```yaml
# frigate/config.yml
cameras:
  backyard:
    zones:
      play_area:
        coordinates: 100,400,800,400,800,1080,100,1080  # safe inner area
      near_fence:
        coordinates: 800,0,1280,0,1280,1080,800,1080    # near the perimeter fence
      outside_gate:
        coordinates: 900,0,1280,0,1280,200,900,200      # outside the gate â€“ danger!
```

These zone names go in `persons.yaml` as `dangerous_zones`:

```yaml
persons:
  Alice:
    role: child
    requires_supervision: true
    dangerous_zones: [near_fence, outside_gate]   # Frigate zone names on camera_backyard
```

When Alice's MQTT event shows `frigate_zones: [near_fence]` the generated
automation fires â€” but only if the supervision sensor is also `off`.

### Level 2 â€“ HA Areas: cross-camera supervision (no extra config needed)

Frigate zones **cannot be shared across cameras** â€” they are scoped to a single
camera's pixel grid.  For supervision, what matters is whether an adult is in
the **same physical area** as the child, regardless of which camera sees them.

**Home Assistant already solves this with Areas.**  If you assign your cameras
to Areas in HA (Settings â†’ Areas & Zones â†’ your Area â†’ Add Device), the
supervision sensor uses `area_name('camera.<name>')` to resolve zones
automatically at runtime:

```
HA UI:  camera.backyard  â†’  Area: "Back Yard"
HA UI:  camera.patio     â†’  Area: "Back Yard"
```

Generated supervision template (no dict baked in):

```jinja2
{# Resolves via HA Area at runtime â€” no static config required #}
{% set child_zone = area_name('camera.' ~ child_camera) or child_camera %}
{% set adult_zone = area_name('camera.' ~ adult_cam)   or adult_cam %}
{% if adult_zone == child_zone %}
  {# supervised â€” same HA Area, possibly different cameras #}
{% endif %}
```

Dad visible on `camera_patio` and Alice on `camera_backyard` are both in Area
`Back Yard` â†’ Alice is supervised.  **No `camera_zones` section is required.**

Zone resolution priority (highest to lowest):
1. **Explicit override** in `persons.yaml` `camera_zones` section (edge cases only)
2. **HA Area** â€” `area_name('camera.<name>')` resolved automatically
3. **Camera name fallback** â€” same-camera supervision only

### Assigning cameras to Areas in HA

1. **Settings â†’ Areas & Zones** â†’ create an area (e.g. "Back Yard")
2. Open the area â†’ **Add Device** â†’ select your Frigate camera device
3. Repeat for all cameras; cameras covering the same physical space get the same area

Once done, re-run the generator â€” supervision sensors will automatically use
your area assignments without any `camera_zones` configuration.

### `camera_zones` override (edge cases only)

The `camera_zones` section in `persons.yaml` is still supported for cases where:
- Cameras have no HA Area assigned yet
- You want finer-grained grouping than your HA Area hierarchy provides

```yaml
# persons.yaml â€” camera_zones is OPTIONAL when cameras are assigned to HA Areas
camera_zones:
  backyard: back_yard    # only needed if camera.backyard has no HA Area
  patio:    back_yard    # only needed if camera.patio has no HA Area
```

### Complete `persons.yaml` example

```yaml
persons:
  Alice:
    role: child
    requires_supervision: true
    dangerous_zones: [near_fence, outside_gate]   # Frigate zones on camera_backyard
    camera: backyard
  Bob:
    role: child
    requires_supervision: true
    dangerous_zones: [near_road]                  # Frigate zone on camera_front_door
    camera: front_door
  Dad:
    role: trusted_adult
    can_supervise: true
    camera: patio

# camera_zones is NOT needed if cameras are assigned to HA Areas.
# Only add this section for cameras without an HA Area assignment.
# camera_zones:
#   backyard: back_yard
#   patio:    back_yard
```

Running the generator with cameras assigned to HA Areas produces:
- A `binary_sensor.alice_supervised` that uses `area_name()` dynamically
- A danger-zone automation that alerts when Alice is in `near_fence` or
  `outside_gate` **and** `binary_sensor.alice_supervised` is `off`

### Blueprint: Supervision Detection

The **Camera Zone Overrides** input defaults to `{}`.  Leave it empty if your
cameras are already assigned to HA Areas â€” supervision is fully automatic.
Only provide entries for cameras that have no HA Area.

---

## Part 5 â€“ Available Blueprints

After running with `--copy-blueprints`, five blueprints are available in
**Settings â†’ Automations & Scenes â†’ Blueprints**:

| Blueprint | Best for |
|---|---|
| **Child Danger Zone Alert** | Alert when child in dangerous Frigate zone without supervision |
| **Vehicle with Children Outside** | Alert when vehicle detected and children are outside |
| **Supervision Detection** | Camera-zone-aware supervised binary sensor per child |
| **Notification Action Handlers** | "Adult Present" / "View Camera" notification buttons |
| **Unknown Person Alert** | Alert on low-confidence / unrecognised detections |

### Creating a Danger Zone Alert (blueprint walkthrough)

1. **Settings â†’ Automations & Scenes â†’ Create Automation**
2. **Start with a blueprint â†’ "Frigate Identity - Child Danger Zone Alert"**
3. Fill in:
   - **Child Name**: `Alice`
   - **Dangerous Zones**: `["near_fence", "outside_gate"]`
   - **Supervision Sensor**: `binary_sensor.alice_supervised`
   - **Notification Service**: `mobile_app_your_phone`
4. **Save** as "Alice Danger Zone Alert"

Repeat for each child with their own zone list.

### Creating Supervision Detection (if not using the generator)

1. **Create Automation â†’ Start with a blueprint â†’ "Frigate Identity - Supervision Detection"**
2. Fill in:
   - **Child Name**: `Alice`
   - **Trusted Adults**: `["Dad", "Mom"]`
   - **Camera Zone Mapping**: `{backyard: back_yard, patio: back_yard}`
   - **Supervision Timeout**: `60`
   - **Manual Override**: `input_boolean.manual_supervision`
3. **Save**

---

## Part 6 â€“ Recommended Setup Sequence

```
Step 1  âœ…  Install integration (HACS or manual)
Step 2  âœ…  Assign Frigate cameras to HA Areas (Settings â†’ Areas & Zones)
Step 3  âœ…  Run generate_dashboard.py with --ha-config-dir + --ha-url + --ha-token + --copy-blueprints + --restart
Step 4  âœ…  Dashboard live at /lovelace/frigate-identity â€” grouped by HA Area
Step 5  ğŸ”²  Create "Manual Supervision" helper (Settings â†’ Helpers â†’ Toggle)
Step 6  ğŸ”²  Create Notification Action Handlers automation (blueprint)
Step 7  ğŸ”²  Edit danger_zone_automations.yaml â€” replace notify.notify with your service
Step 8  ğŸ”²  (Optional) Install AppDaemon app for fully automatic updates (see Part 7)
Step 9  ğŸ”²  (Optional) Create Unknown Person Alert for outdoor cameras
Step 10 ğŸ”²  (Optional) Create Vehicle with Children Outside alert
```

---

## Part 7 â€“ AppDaemon: Fully Automatic Updates

Once the initial setup is done, the **AppDaemon app** keeps everything
up-to-date without any manual intervention:

| Trigger | What happens |
|---|---|
| HA starts | Full regeneration run |
| Camera Area changed in HA UI | Dashboard re-grouped automatically (10 s debounce) |
| `persons.yaml` saved | New persons/zones picked up automatically (30 s poll) |
| Daily at 03:00 | Full refresh to catch any drift |

### Prerequisites

1. **AppDaemon add-on** installed from the Home Assistant Community Add-ons repository:
   Settings â†’ Add-ons â†’ Add-on Store â†’ search "AppDaemon"
2. The add-on must be configured with a long-lived access token in
   `/config/appdaemon/appdaemon.yaml`

### Installation

**1. Copy the app files into the AppDaemon apps directory:**

```bash
cp appdaemon/apps/frigate_identity_dashboard.py /config/appdaemon/apps/
cp appdaemon/apps/requirements.txt /config/appdaemon/apps/
```

**2. Configure the app in `/config/appdaemon/apps/apps.yaml`:**

```yaml
frigate_identity:
  module: frigate_identity_dashboard
  class: FrigateIdentityDashboard
  persons_file: /config/persons.yaml
  output_dir: /config/frigate_identity
  ha_config_dir: /config
  ha_url: http://localhost:8123
  ha_token: !secret ha_long_lived_token
  snapshot_source: mqtt
  copy_blueprints: true
  auto_restart: false        # set to true for the very first run only
```

Add your token to `/config/secrets.yaml`:
```yaml
ha_long_lived_token: eyJ...your_token_here...
```

**3. Restart the AppDaemon add-on.**  The app runs immediately and logs to
the AppDaemon add-on log (visible under Add-ons â†’ AppDaemon â†’ Log).

### Workflow after initial setup

```
You change a camera's Area in HA UI
       â†“  (area_registry_updated event fired)
       â†“  (10 s debounce)
AppDaemon app calls generate()
       â†“
New dashboard.yaml with updated area grouping
       â†“
Lovelace view pushed to HA automatically
       â†“
Dashboard refreshed â€” no manual steps
```

```
You add a new person to persons.yaml
       â†“  (file mtime changed, detected within 30 s)
AppDaemon app calls generate()
       â†“
New sensors, cameras, automations, and dashboard written
       â†“
HA restart needed (set auto_restart: true or restart manually)
       â†“
New person appears in dashboard
```

### Tuning options

| Config key | Default | Description |
|---|---|---|
| `auto_restart` | `false` | Restart HA after generation. Enable for the first run, disable after. |
| `debounce_seconds` | `10` | Seconds to wait after last event before regenerating |
| `file_poll_interval` | `30` | How often (seconds) to check `persons.yaml` for changes |
| `daily_refresh_time` | `"03:00"` | Daily full-refresh time (HH:MM local) |

---

## Troubleshooting

### Dashboard shows "Entity not found" / grey cards

The entities were not created. Check:
1. HA was restarted after the generator ran
2. **Developer Tools â†’ States** â€” search for `alice_location`
3. If missing: check that `packages/frigate_identity.yaml` exists and packages
   are enabled in `configuration.yaml`

### Snapshot card is blank

1. The Identity Service must be running and publishing to `identity/snapshots/{person}`
2. **Developer Tools â†’ MQTT â†’ Listen** â†’ subscribe to `identity/snapshots/#`
3. Verify Frigate has `mqtt.crop: true` for each camera

### Supervision always shows "off" in a multi-camera yard

1. **Check HA Area assignments**: Settings â†’ Areas & Zones â†’ open the area â†’
   confirm both cameras (child's and adult's) are listed under that area
2. In **Developer Tools â†’ Template**, test the area lookup:
   ```
   {{ area_name('camera.backyard') }}
   {{ area_name('camera.patio') }}
   ```
   Both should return the same area name.  If either returns empty, assign the
   camera to an area in HA, or add a `camera_zones` override in `persons.yaml`
3. If using `camera_zones` overrides, verify the camera names in the mapping
   match the Frigate camera names exactly (case-sensitive)
4. Re-run the generator (or wait for AppDaemon to pick up the change) and restart HA

### Danger zone alert not firing

1. Check that the `dangerous_zones` names in `persons.yaml` exactly match the
   **Frigate zone names** defined in `frigate/config.yml` for that camera
2. In **Developer Tools â†’ MQTT â†’ Listen**, subscribe to `identity/person/#`
   and walk into the zone â€” confirm `frigate_zones` in the payload contains
   the expected zone name
3. Check the automation trace in HA for which condition failed

### AppDaemon app not regenerating

1. Check the AppDaemon add-on log for errors (Add-ons â†’ AppDaemon â†’ Log)
2. Verify `generator_script` path points to `generate_dashboard.py`
   (default: `/config/custom_components/frigate_identity/examples/generate_dashboard.py`)
3. Verify `ha_token` is set correctly in `secrets.yaml`
4. Restart the AppDaemon add-on to trigger an immediate regeneration run

### Dashboard push failed (HA YAML Lovelace mode)

If you see "HA may be in YAML Lovelace mode", your Lovelace is configured via
`lovelace:` in `configuration.yaml`. Switch to storage mode or paste
`dashboard.yaml` manually via the Raw configuration editor.

### Blueprint not appearing in HA

1. File must be in `/config/blueprints/automation/frigate_identity/`
   (re-run with `--copy-blueprints` or set `copy_blueprints: true` in AppDaemon config)
2. No HA restart needed â€” blueprints are hot-loaded
3. Check for YAML syntax errors: **Developer Tools â†’ Template** â†’ paste the
   blueprint YAML to check for errors


