# Frigate Identity â€“ Dashboard Setup & Further Automations

This guide covers the end-to-end flow: generating the configuration, wiring it
into Home Assistant, and setting up automations for yard safety monitoring.

---

## Part 1 â€“ Generate the Configuration Files

If you have a `persons.yaml` from the [Frigate Identity Service](https://github.com/awayman/frigate_identity_service), point the generator at it:

```bash
pip install pyyaml
python examples/generate_dashboard.py \
    --persons-file /path/to/frigate_identity_service/persons.yaml \
    --output /config/frigate_identity
```

Or supply person names directly:

```bash
python examples/generate_dashboard.py \
    --output /config/frigate_identity \
    Alice Bob Dad Mom
```

The generator writes these files to `/config/frigate_identity/`:

| File | What it contains |
|---|---|
| `mqtt_cameras.yaml` | MQTT `camera` entities â€” one per person (bounded snapshot) |
| `template_sensors.yaml` | Per-person location sensors + zone-aware supervision binary sensors |
| `dashboard.yaml` | Full Lovelace dashboard YAML (proper `views:` structure) |
| `danger_zone_automations.yaml` | Danger-zone automations *(only when children have `dangerous_zones`)* |

---

## Part 2 â€“ Automated One-Command Setup (Recommended)

If your HA `/config` directory is accessible (HA OS, Container, or SSH), you
can let the generator configure **everything** in a single command:

```bash
python examples/generate_dashboard.py \
    --persons-file /config/persons.yaml \
    --output /config/frigate_identity \
    --ha-config-dir /config \
    --ha-url http://homeassistant.local:8123 \
    --ha-token YOUR_LONG_LIVED_ACCESS_TOKEN \
    --copy-blueprints \
    --restart
```

What each flag does:

| Flag | What it automates |
|---|---|
| `--ha-config-dir /config` | Writes `packages/frigate_identity.yaml` (wires sensors/cameras/automations into HA). Patches `configuration.yaml` to enable packages if needed. |
| `--ha-url` + `--ha-token` | Pushes the Lovelace dashboard directly via the HA REST API â€” no pasting required. |
| `--copy-blueprints` | Copies blueprint files to `/config/blueprints/automation/frigate_identity/`. |
| `--restart` | Triggers a Home Assistant restart after all changes. |

**Getting a long-lived access token:**
In HA â†’ Profile (bottom-left) â†’ Security tab â†’ Long-Lived Access Tokens â†’ Create.

After the restart, the Frigate Identity view is live at `/lovelace/frigate-identity`.

### Re-running after changes

When you update `persons.yaml` (add/remove a person), just re-run:

```bash
python examples/generate_dashboard.py \
    --persons-file /config/persons.yaml \
    --output /config/frigate_identity \
    --ha-config-dir /config \
    --ha-url http://homeassistant.local:8123 \
    --ha-token YOUR_TOKEN \
    --restart
```

The package file and dashboard are overwritten in-place; `configuration.yaml`
is not touched again once packages are already enabled.

---

## Part 3 â€“ Manual Setup (Alternative)

Use this path if your HA config directory is not directly accessible.

### 3a. Wire files into configuration.yaml

Add `!include` directives to `/config/configuration.yaml`:

```yaml
mqtt:
  camera: !include frigate_identity/mqtt_cameras.yaml

template: !include frigate_identity/template_sensors.yaml

automation: !include frigate_identity/danger_zone_automations.yaml
```

> **Tip â€” use HA packages instead:** Add a single `homeassistant: packages:
> !include_dir_named packages` line once, then drop
> `packages/frigate_identity.yaml` (generated by `--ha-config-dir`) alongside
> it. Future re-runs only update that one package file â€” no further edits to
> `configuration.yaml` ever needed.

Restart Home Assistant.

### 3b. Create the Lovelace dashboard

1. **Settings â†’ Dashboards â†’ + Add dashboard**
2. Title: `Frigate Identity` / Icon: `mdi:account-search`
3. Open the new dashboard â†’ **Edit âœï¸** â†’ **â‹® menu â†’ Raw configuration editor**
4. Select all existing content, replace with the contents of `dashboard.yaml`, click **Save**

---

## Part 4 â€“ Two-Level Zone Model for Large Yards

For a child playing in a large yard covered by multiple cameras, safety
monitoring uses **two different zone concepts** that serve distinct purposes.
Understanding the difference is key to configuring the system correctly.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 1 â€“ Frigate camera zones  (per-camera pixel regions)      â”‚
â”‚  Purpose: WHERE is the child within the camera view?             â”‚
â”‚  Set in:  persons.yaml  dangerous_zones                          â”‚
â”‚  Used in: danger_zone_automations.yaml  (location trigger)       â”‚
â”‚  Example: "near_fence", "outside_gate" on camera_backyard        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Level 2 â€“ camera_zones mapping  (logical supervision areas)     â”‚
â”‚  Purpose: Is an adult in the same PHYSICAL area as the child?    â”‚
â”‚  Set in:  persons.yaml  camera_zones section                     â”‚
â”‚  Used in: binary_sensor.<child>_supervised  (supervision sensor) â”‚
â”‚  Example: cameras backyard + patio â†’ both in zone "back_yard"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“ combined â†“
    Alert when child is in a dangerous Frigate zone  AND  unsupervised
```

### Level 1 â€“ Frigate camera zones: dangerous location detection

Frigate zones are **pixel-region annotations on a single camera**.  They are
the right tool for detecting *where within a camera view* a child is.

For example, on `camera_backyard` you might define:

```yaml
# frigate/config.yml
cameras:
  backyard:
    zones:
      play_area:
        coordinates: 100,400,800,400,800,1080,100,1080  # safe inner area
      near_fence:
        coordinates: 800,0,1280,0,1280,1080,800,1080    # near the perimeter fence
      outside_gate:
        coordinates: 900,0,1280,0,1280,200,900,200      # outside the gate â€“ danger!
```

These zone names go in `persons.yaml` as `dangerous_zones`:

```yaml
persons:
  Alice:
    role: child
    requires_supervision: true
    dangerous_zones: [near_fence, outside_gate]   # Frigate zone names on camera_backyard
```

When Alice's MQTT event shows `frigate_zones: [near_fence]` the generated
automation fires â€” but only if the supervision sensor is also `off`.

### Level 2 â€“ `camera_zones` mapping: cross-camera supervision

Frigate zones **cannot be shared across cameras**.  A zone named `play_area` on
`camera_backyard` and one named `play_area` on `camera_patio` are completely
independent pixel regions with no relationship.

For supervision, what matters is whether an adult is in the **same physical
area** as the child â€” even if they appear on a different camera.  The
`camera_zones` mapping in `persons.yaml` defines this:

```yaml
# persons.yaml â€” top-level section alongside persons:
camera_zones:
  backyard: back_yard   # cameras "backyard" and "patio" both cover the back yard
  patio:    back_yard
  front_door: front_entry
  driveway:   front_entry
```

The generated supervision sensor resolves each camera to its zone and compares:

```jinja2
{% set camera_zones = {'backyard': 'back_yard', 'patio': 'back_yard', ...} %}
{% set child_zone = camera_zones.get(child_camera, child_camera) %}
{% set adult_zone = camera_zones.get(persons[adult].camera, persons[adult].camera) %}
{% if adult_zone == child_zone %}
  {# supervised â€” same logical area, possibly different cameras #}
{% endif %}
```

Dad visible on `camera_patio` and Alice on `camera_backyard` are both in zone
`back_yard` â†’ Alice is supervised even though they are on different cameras.

**When no `camera_zones` section is present**, the mapping is `{}` and
`.get(camera, camera)` returns the camera name itself â€” supervision falls back
to requiring the same camera.

### Complete `persons.yaml` example

```yaml
persons:
  Alice:
    role: child
    requires_supervision: true
    dangerous_zones: [near_fence, outside_gate]   # Frigate zones on camera_backyard
    camera: backyard
  Bob:
    role: child
    requires_supervision: true
    dangerous_zones: [near_road]                  # Frigate zone on camera_front_door
    camera: front_door
  Dad:
    role: trusted_adult
    can_supervise: true
    camera: patio                                 # Patio camera covers same area as backyard

# Logical supervision areas (for cross-camera supervision checks).
# This is NOT about Frigate zones â€” it groups cameras by physical location.
camera_zones:
  backyard: back_yard    # Dad on patio supervises Alice in backyard
  patio:    back_yard    # because both map to "back_yard"
  front_door: front_entry
  driveway:   front_entry
```

Running the generator with this file produces:
- A `binary_sensor.alice_supervised` that is `on` when Dad (or Mom) is in
  `back_yard` â€” regardless of which camera they appear on
- A danger-zone automation that alerts when Alice is in `near_fence` or
  `outside_gate` **and** `binary_sensor.alice_supervised` is `off`

### Blueprint: Supervision Detection

When using the blueprint instead of the generator, fill in **Camera Zone Mapping**:

```
{backyard: back_yard, patio: back_yard, front_door: front_entry}
```

Leave it as `{}` for same-camera-only supervision (single-camera setups).

---

## Part 5 â€“ Available Blueprints

After running with `--copy-blueprints`, five blueprints are available in
**Settings â†’ Automations & Scenes â†’ Blueprints**:

| Blueprint | Best for |
|---|---|
| **Child Danger Zone Alert** | Alert when child in dangerous Frigate zone without supervision |
| **Vehicle with Children Outside** | Alert when vehicle detected and children are outside |
| **Supervision Detection** | Camera-zone-aware supervised binary sensor per child |
| **Notification Action Handlers** | "Adult Present" / "View Camera" notification buttons |
| **Unknown Person Alert** | Alert on low-confidence / unrecognised detections |

### Creating a Danger Zone Alert (blueprint walkthrough)

1. **Settings â†’ Automations & Scenes â†’ Create Automation**
2. **Start with a blueprint â†’ "Frigate Identity - Child Danger Zone Alert"**
3. Fill in:
   - **Child Name**: `Alice`
   - **Dangerous Zones**: `["near_fence", "outside_gate"]`
   - **Supervision Sensor**: `binary_sensor.alice_supervised`
   - **Notification Service**: `mobile_app_your_phone`
4. **Save** as "Alice Danger Zone Alert"

Repeat for each child with their own zone list.

### Creating Supervision Detection (if not using the generator)

1. **Create Automation â†’ Start with a blueprint â†’ "Frigate Identity - Supervision Detection"**
2. Fill in:
   - **Child Name**: `Alice`
   - **Trusted Adults**: `["Dad", "Mom"]`
   - **Camera Zone Mapping**: `{backyard: back_yard, patio: back_yard}`
   - **Supervision Timeout**: `60`
   - **Manual Override**: `input_boolean.manual_supervision`
3. **Save**

---

## Part 6 â€“ Recommended Setup Sequence

```
Step 1  âœ…  Install integration (HACS or manual)
Step 2  âœ…  Add camera_zones section to persons.yaml (for multi-camera yards)
Step 3  âœ…  Run generate_dashboard.py with --ha-config-dir + --ha-url + --ha-token + --copy-blueprints + --restart
Step 4  âœ…  Dashboard live at /lovelace/frigate-identity
Step 5  ğŸ”²  Create "Manual Supervision" helper (Settings â†’ Helpers â†’ Toggle)
Step 6  ğŸ”²  Create Notification Action Handlers automation (blueprint)
Step 7  ğŸ”²  Edit danger_zone_automations.yaml â€” replace notify.notify with your service
Step 8  ğŸ”²  (Optional) Create Unknown Person Alert for outdoor cameras
Step 9  ğŸ”²  (Optional) Create Vehicle with Children Outside alert
```

---

## Troubleshooting

### Dashboard shows "Entity not found" / grey cards

The entities were not created. Check:
1. HA was restarted after the generator ran
2. **Developer Tools â†’ States** â€” search for `alice_location`
3. If missing: check that `packages/frigate_identity.yaml` exists and packages
   are enabled in `configuration.yaml`

### Snapshot card is blank

1. The Identity Service must be running and publishing to `identity/snapshots/{person}`
2. **Developer Tools â†’ MQTT â†’ Listen** â†’ subscribe to `identity/snapshots/#`
3. Verify Frigate has `mqtt.crop: true` for each camera

### Supervision always shows "off" in a multi-camera yard

1. Check that `camera_zones` is present in `persons.yaml` and includes every
   camera where children or adults might appear
2. Verify that cameras covering the same physical area share the **same zone
   name** in the mapping (e.g. both `backyard` and `patio` map to `back_yard`)
3. Re-run the generator after adding `camera_zones` and restart HA
4. In **Developer Tools â†’ Template**, paste the supervision sensor state
   template to evaluate it live with current person data

### Danger zone alert not firing

1. Check that the `dangerous_zones` names in `persons.yaml` exactly match the
   **Frigate zone names** defined in `frigate/config.yml` for that camera
2. In **Developer Tools â†’ MQTT â†’ Listen**, subscribe to `identity/person/#`
   and walk into the zone â€” confirm `frigate_zones` in the payload contains
   the expected zone name
3. Check the automation trace in HA for which condition failed

### Dashboard push failed (HA YAML Lovelace mode)

If you see "HA may be in YAML Lovelace mode", your Lovelace is configured via
`lovelace:` in `configuration.yaml`. Switch to storage mode or paste
`dashboard.yaml` manually via the Raw configuration editor.

### Blueprint not appearing in HA

1. File must be in `/config/blueprints/automation/frigate_identity/`
   (re-run with `--copy-blueprints` or copy manually)
2. No HA restart needed â€” blueprints are hot-loaded
3. Check for YAML syntax errors: **Developer Tools â†’ Template** â†’ paste the
   blueprint YAML to check for errors

