# Frigate Identity â€“ Dashboard Setup & Further Automations

This guide covers the end-to-end flow: generating the configuration, wiring it
into Home Assistant, and setting up automations for yard safety monitoring.

---

## Part 1 â€“ Generate the Configuration Files

If you have a `persons.yaml` from the [Frigate Identity Service](https://github.com/awayman/frigate_identity_service), point the generator at it:

```bash
pip install pyyaml
python examples/generate_dashboard.py \
    --persons-file /path/to/frigate_identity_service/persons.yaml \
    --output /config/frigate_identity
```

Or supply person names directly:

```bash
python examples/generate_dashboard.py \
    --output /config/frigate_identity \
    Alice Bob Dad Mom
```

The generator writes these files to `/config/frigate_identity/`:

| File | What it contains |
|---|---|
| `mqtt_cameras.yaml` | MQTT `camera` entities â€” one per person (bounded snapshot) |
| `template_sensors.yaml` | Per-person location sensors + zone-aware supervision binary sensors |
| `dashboard.yaml` | Full Lovelace dashboard YAML (proper `views:` structure) |
| `danger_zone_automations.yaml` | Danger-zone automations *(only when children have `dangerous_zones`)* |

---

## Part 2 â€“ Automated One-Command Setup (Recommended)

If your HA `/config` directory is accessible (HA OS, Container, or SSH), you
can let the generator configure **everything** in a single command:

```bash
python examples/generate_dashboard.py \
    --persons-file /config/persons.yaml \
    --output /config/frigate_identity \
    --ha-config-dir /config \
    --ha-url http://homeassistant.local:8123 \
    --ha-token YOUR_LONG_LIVED_ACCESS_TOKEN \
    --copy-blueprints \
    --restart
```

What each flag does:

| Flag | What it automates |
|---|---|
| `--ha-config-dir /config` | Writes `packages/frigate_identity.yaml` (wires sensors/cameras/automations into HA). Patches `configuration.yaml` to enable packages if needed. |
| `--ha-url` + `--ha-token` | Pushes the Lovelace dashboard directly via the HA REST API â€” no pasting required. |
| `--copy-blueprints` | Copies blueprint files to `/config/blueprints/automation/frigate_identity/`. |
| `--restart` | Triggers a Home Assistant restart after all changes. |

**Getting a long-lived access token:**
In HA â†’ Profile (bottom-left) â†’ Security tab â†’ Long-Lived Access Tokens â†’ Create.

After the restart, the Frigate Identity view is live at `/lovelace/frigate-identity`.

### Re-running after changes

When you update `persons.yaml` (add/remove a person), just re-run:

```bash
python examples/generate_dashboard.py \
    --persons-file /config/persons.yaml \
    --output /config/frigate_identity \
    --ha-config-dir /config \
    --ha-url http://homeassistant.local:8123 \
    --ha-token YOUR_TOKEN \
    --restart
```

The package file and dashboard are overwritten in-place; `configuration.yaml`
is not touched again once packages are already enabled.

---

## Part 3 â€“ Manual Setup (Alternative)

Use this path if your HA config directory is not directly accessible.

### 3a. Wire files into configuration.yaml

Add `!include` directives to `/config/configuration.yaml`:

```yaml
mqtt:
  camera: !include frigate_identity/mqtt_cameras.yaml

template: !include frigate_identity/template_sensors.yaml

automation: !include frigate_identity/danger_zone_automations.yaml
```

> **Tip â€” use HA packages instead:** Add a single `homeassistant: packages:
> !include_dir_named packages` line once, then drop
> `packages/frigate_identity.yaml` (generated by `--ha-config-dir`) alongside
> it. Future re-runs only update that one package file â€” no further edits to
> `configuration.yaml` ever needed.

Restart Home Assistant.

### 3b. Create the Lovelace dashboard

1. **Settings â†’ Dashboards â†’ + Add dashboard**
2. Title: `Frigate Identity` / Icon: `mdi:account-search`
3. Open the new dashboard â†’ **Edit âœï¸** â†’ **â‹® menu â†’ Raw configuration editor**
4. Select all existing content, replace with the contents of `dashboard.yaml`, click **Save**

---

## Part 4 â€“ Zone-Aware Supervision (Large Yards)

The supervision binary sensors generated by the script â€” and the
**Supervision Detection** blueprint â€” use a **zone-aware** algorithm that is
specifically designed for large yards with multiple cameras:

> A child is considered supervised when any trusted adult was seen within the
> last 60 seconds AND either **shares the same camera** OR **shares at least
> one active Frigate zone** with the child.

### Why this matters

In a large yard with several overlapping camera views, a parent standing at the
garden table may appear on `camera_patio` while a child plays near the fence
visible on `camera_backyard`. If both cameras cover a shared Frigate zone
(e.g. `play_area`), the child is correctly marked supervised even though they
are on different cameras.

With the old camera-only check, this situation would report "unsupervised" and
trigger false danger-zone alerts.

### Setting up zones in Frigate

Define zones in your Frigate `config.yml` that reflect the physical areas:

```yaml
cameras:
  backyard:
    zones:
      play_area:
        coordinates: 100,400,800,400,800,1080,100,1080
      near_fence:
        coordinates: 600,0,1280,0,1280,400,600,400
      street_view:
        coordinates: 0,0,600,0,600,300,0,300

  patio:
    zones:
      play_area:          # same zone name â€” both cameras cover this area
        coordinates: 0,200,1280,200,1280,1080,0,1080
```

Name your `dangerous_zones` in `persons.yaml` to match these Frigate zone names:

```yaml
persons:
  Alice:
    role: child
    requires_supervision: true
    dangerous_zones: [near_fence, street_view]
  Dad:
    role: trusted_adult
    can_supervise: true
```

Run the generator â€” it produces a supervision binary sensor for Alice that
checks whether Dad (or any other adult) is in the same zone, plus a
danger-zone automation that only fires when Alice is unsupervised.

---

## Part 5 â€“ Available Blueprints

After running with `--copy-blueprints`, five blueprints are available in
**Settings â†’ Automations & Scenes â†’ Blueprints**:

| Blueprint | Best for |
|---|---|
| **Child Danger Zone Alert** | Alert when child in dangerous zone without supervision |
| **Vehicle with Children Outside** | Alert when vehicle detected and children are outside |
| **Supervision Detection** | Zone-aware supervised binary sensor per child |
| **Notification Action Handlers** | "Adult Present" / "View Camera" notification buttons |
| **Unknown Person Alert** | Alert on low-confidence / unrecognised detections |

### Creating a Danger Zone Alert (blueprint walkthrough)

1. **Settings â†’ Automations & Scenes â†’ Create Automation**
2. **Start with a blueprint â†’ "Frigate Identity - Child Danger Zone Alert"**
3. Fill in:
   - **Child Name**: `Alice`
   - **Dangerous Zones**: `["near_fence", "street_view"]`
   - **Supervision Sensor**: `binary_sensor.alice_supervised`
   - **Notification Service**: `mobile_app_your_phone`
4. **Save** as "Alice Danger Zone Alert"

Repeat for each child with their own zone list.

### Creating Supervision Detection (if not using the generator)

1. **Create Automation â†’ Start with a blueprint â†’ "Frigate Identity - Supervision Detection"**
2. Fill in:
   - **Child Name**: `Alice`
   - **Trusted Adults**: `["Dad", "Mom"]`
   - **Supervision Timeout**: `60`
   - **Manual Override**: `input_boolean.manual_supervision`
3. **Save**

---

## Part 6 â€“ Recommended Setup Sequence

```
Step 1  âœ…  Install integration (HACS or manual)
Step 2  âœ…  Run generate_dashboard.py with --ha-config-dir + --ha-url + --ha-token + --copy-blueprints + --restart
Step 3  âœ…  Dashboard live at /lovelace/frigate-identity
Step 4  ðŸ”²  Create "Manual Supervision" helper (Settings â†’ Helpers â†’ Toggle)
Step 5  ðŸ”²  Create Notification Action Handlers automation (blueprint)
Step 6  ðŸ”²  Edit danger_zone_automations.yaml â€” replace notify.notify with your service
Step 7  ðŸ”²  Create Unknown Person Alert automation (blueprint) for outdoor cameras
Step 8  ðŸ”²  (Optional) Create Vehicle with Children Outside alert
```

---

## Troubleshooting

### Dashboard shows "Entity not found" / grey cards

The entities were not created. Check:
1. HA was restarted after the generator ran
2. **Developer Tools â†’ States** â€” search for `alice_location`
3. If missing: check that `packages/frigate_identity.yaml` exists and packages
   are enabled in `configuration.yaml`

### Snapshot card is blank

1. The Identity Service must be running and publishing to `identity/snapshots/{person}`
2. **Developer Tools â†’ MQTT â†’ Listen** â†’ subscribe to `identity/snapshots/#`
3. Verify Frigate has `mqtt.crop: true` for each camera

### Supervision always shows "off" in large yard

Check that your Frigate zone names in `config.yml` **exactly match** the zone
names in `persons.yaml` `dangerous_zones` and that both cameras covering the
shared zone use the **same zone name**.

### Dashboard push failed (HA YAML Lovelace mode)

If you see "HA may be in YAML Lovelace mode", your Lovelace is configured via
`lovelace:` in `configuration.yaml`. Switch to storage mode or paste
`dashboard.yaml` manually via the Raw configuration editor.

### Blueprint not appearing in HA

1. File must be in `/config/blueprints/automation/frigate_identity/`
   (re-run with `--copy-blueprints` or copy manually)
2. No HA restart needed â€” blueprints are hot-loaded
3. Check for YAML syntax errors: **Developer Tools â†’ Template** â†’ paste the
   blueprint YAML to check for errors
