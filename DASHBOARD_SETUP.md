# Frigate Identity â€“ Dashboard Setup & Further Automations

This guide covers the end-to-end flow: generating the configuration, wiring it
into Home Assistant, and setting up automations for yard safety monitoring.

---

## Part 1 â€“ Generate the Configuration Files

If you have a `persons.yaml` from the [Frigate Identity Service](https://github.com/awayman/frigate_identity_service), point the generator at it:

```bash
pip install pyyaml
python examples/generate_dashboard.py \
    --persons-file /path/to/frigate_identity_service/persons.yaml \
    --output /config/frigate_identity
```

Or supply person names directly:

```bash
python examples/generate_dashboard.py \
    --output /config/frigate_identity \
    Alice Bob Dad Mom
```

The generator writes these files to `/config/frigate_identity/`:

| File | What it contains |
|---|---|
| `mqtt_cameras.yaml` | MQTT `camera` entities â€” one per person (bounded snapshot) |
| `template_sensors.yaml` | Per-person location sensors + zone-aware supervision binary sensors |
| `dashboard.yaml` | Full Lovelace dashboard YAML (proper `views:` structure) |
| `danger_zone_automations.yaml` | Danger-zone automations *(only when children have `dangerous_zones`)* |

---

## Part 2 â€“ Automated One-Command Setup (Recommended)

If your HA `/config` directory is accessible (HA OS, Container, or SSH), you
can let the generator configure **everything** in a single command:

```bash
python examples/generate_dashboard.py \
    --persons-file /config/persons.yaml \
    --output /config/frigate_identity \
    --ha-config-dir /config \
    --ha-url http://homeassistant.local:8123 \
    --ha-token YOUR_LONG_LIVED_ACCESS_TOKEN \
    --copy-blueprints \
    --restart
```

What each flag does:

| Flag | What it automates |
|---|---|
| `--ha-config-dir /config` | Writes `packages/frigate_identity.yaml` (wires sensors/cameras/automations into HA). Patches `configuration.yaml` to enable packages if needed. |
| `--ha-url` + `--ha-token` | Pushes the Lovelace dashboard directly via the HA REST API â€” no pasting required. |
| `--copy-blueprints` | Copies blueprint files to `/config/blueprints/automation/frigate_identity/`. |
| `--restart` | Triggers a Home Assistant restart after all changes. |

**Getting a long-lived access token:**
In HA â†’ Profile (bottom-left) â†’ Security tab â†’ Long-Lived Access Tokens â†’ Create.

After the restart, the Frigate Identity view is live at `/lovelace/frigate-identity`.

### Re-running after changes

When you update `persons.yaml` (add/remove a person), just re-run:

```bash
python examples/generate_dashboard.py \
    --persons-file /config/persons.yaml \
    --output /config/frigate_identity \
    --ha-config-dir /config \
    --ha-url http://homeassistant.local:8123 \
    --ha-token YOUR_TOKEN \
    --restart
```

The package file and dashboard are overwritten in-place; `configuration.yaml`
is not touched again once packages are already enabled.

---

## Part 3 â€“ Manual Setup (Alternative)

Use this path if your HA config directory is not directly accessible.

### 3a. Wire files into configuration.yaml

Add `!include` directives to `/config/configuration.yaml`:

```yaml
mqtt:
  camera: !include frigate_identity/mqtt_cameras.yaml

template: !include frigate_identity/template_sensors.yaml

automation: !include frigate_identity/danger_zone_automations.yaml
```

> **Tip â€” use HA packages instead:** Add a single `homeassistant: packages:
> !include_dir_named packages` line once, then drop
> `packages/frigate_identity.yaml` (generated by `--ha-config-dir`) alongside
> it. Future re-runs only update that one package file â€” no further edits to
> `configuration.yaml` ever needed.

Restart Home Assistant.

### 3b. Create the Lovelace dashboard

1. **Settings â†’ Dashboards â†’ + Add dashboard**
2. Title: `Frigate Identity` / Icon: `mdi:account-search`
3. Open the new dashboard â†’ **Edit âœï¸** â†’ **â‹® menu â†’ Raw configuration editor**
4. Select all existing content, replace with the contents of `dashboard.yaml`, click **Save**

---

## Part 4 â€“ Supervision Zones for Large Yards

The supervision binary sensors generated by the script â€” and the
**Supervision Detection** blueprint â€” determine whether a child is supervised
using a **camera â†’ logical zone** mapping.

> A child is considered supervised when any trusted adult was seen within
> the last 60 seconds AND both their cameras resolve to the **same zone name**
> in the `camera_zones` mapping.

### Why a camera mapping is needed

Frigate zones are **per-camera pixel regions** â€” they are not shared across
cameras.  A zone named `play_area` on `camera_backyard` and a zone named
`play_area` on `camera_patio` are entirely separate entities with no
relationship.  Cross-camera supervision cannot use Frigate zones.

Instead, you define a `camera_zones` mapping that groups cameras by the
physical area they cover.  Dad visible on `camera_patio` and Alice visible on
`camera_backyard` are correctly treated as co-located when both cameras map to
the same zone (e.g. `back_yard`).

### Adding `camera_zones` to `persons.yaml`

Add a top-level `camera_zones` section alongside `persons:` in your
`persons.yaml`:

```yaml
persons:
  Alice:
    role: child
    requires_supervision: true
    dangerous_zones: [near_fence, street_view]
    camera: backyard
  Bob:
    role: child
    requires_supervision: true
    dangerous_zones: [street_view]
    camera: front_door
  Dad:
    role: trusted_adult
    can_supervise: true
    camera: patio

# Map each Frigate camera to a logical supervision zone.
# Cameras with the same zone name are treated as the same physical area.
camera_zones:
  backyard: back_yard    # these two cameras both cover the back yard
  patio: back_yard
  front_door: front_entry
  driveway: front_entry
```

The generator embeds this mapping directly into the supervision sensor template:

```jinja2
{% set camera_zones = {'backyard': 'back_yard', 'patio': 'back_yard', ...} %}
{% set child_zone = camera_zones.get(child_camera, child_camera) %}
{% set adult_zone = camera_zones.get(persons[adult].camera, persons[adult].camera) %}
{% if adult_zone == child_zone %}
  {# supervised! #}
{% endif %}
```

**When no `camera_zones` section is present**, `camera_zones` is `{}` and the
`.get(camera, camera)` calls return the camera name itself â€” making supervision
fall back to requiring the same camera.  This is the correct behaviour for
single-camera setups.

### Blueprint: Supervision Detection

When using the blueprint instead of the generator, fill in the
**Camera Zone Mapping** input with the same dict:

```
Camera Zone Mapping:
  {backyard: back_yard, patio: back_yard, front_door: front_entry}
```

Leave it as `{}` for same-camera-only supervision.

---

## Part 5 â€“ Available Blueprints

After running with `--copy-blueprints`, five blueprints are available in
**Settings â†’ Automations & Scenes â†’ Blueprints**:

| Blueprint | Best for |
|---|---|
| **Child Danger Zone Alert** | Alert when child in dangerous zone without supervision |
| **Vehicle with Children Outside** | Alert when vehicle detected and children are outside |
| **Supervision Detection** | Zone-aware supervised binary sensor per child |
| **Notification Action Handlers** | "Adult Present" / "View Camera" notification buttons |
| **Unknown Person Alert** | Alert on low-confidence / unrecognised detections |

### Creating a Danger Zone Alert (blueprint walkthrough)

1. **Settings â†’ Automations & Scenes â†’ Create Automation**
2. **Start with a blueprint â†’ "Frigate Identity - Child Danger Zone Alert"**
3. Fill in:
   - **Child Name**: `Alice`
   - **Dangerous Zones**: `["near_fence", "street_view"]`
   - **Supervision Sensor**: `binary_sensor.alice_supervised`
   - **Notification Service**: `mobile_app_your_phone`
4. **Save** as "Alice Danger Zone Alert"

Repeat for each child with their own zone list.

### Creating Supervision Detection (if not using the generator)

1. **Create Automation â†’ Start with a blueprint â†’ "Frigate Identity - Supervision Detection"**
2. Fill in:
   - **Child Name**: `Alice`
   - **Trusted Adults**: `["Dad", "Mom"]`
   - **Supervision Timeout**: `60`
   - **Manual Override**: `input_boolean.manual_supervision`
3. **Save**

---

## Part 6 â€“ Recommended Setup Sequence

```
Step 1  âœ…  Install integration (HACS or manual)
Step 2  âœ…  Run generate_dashboard.py with --ha-config-dir + --ha-url + --ha-token + --copy-blueprints + --restart
Step 3  âœ…  Dashboard live at /lovelace/frigate-identity
Step 4  ðŸ”²  Create "Manual Supervision" helper (Settings â†’ Helpers â†’ Toggle)
Step 5  ðŸ”²  Create Notification Action Handlers automation (blueprint)
Step 6  ðŸ”²  Edit danger_zone_automations.yaml â€” replace notify.notify with your service
Step 7  ðŸ”²  Create Unknown Person Alert automation (blueprint) for outdoor cameras
Step 8  ðŸ”²  (Optional) Create Vehicle with Children Outside alert
```

---

## Troubleshooting

### Dashboard shows "Entity not found" / grey cards

The entities were not created. Check:
1. HA was restarted after the generator ran
2. **Developer Tools â†’ States** â€” search for `alice_location`
3. If missing: check that `packages/frigate_identity.yaml` exists and packages
   are enabled in `configuration.yaml`

### Snapshot card is blank

1. The Identity Service must be running and publishing to `identity/snapshots/{person}`
2. **Developer Tools â†’ MQTT â†’ Listen** â†’ subscribe to `identity/snapshots/#`
3. Verify Frigate has `mqtt.crop: true` for each camera

### Supervision always shows "off" in large yard

Check that your Frigate zone names in `config.yml` **exactly match** the zone
names in `persons.yaml` `dangerous_zones` and that both cameras covering the
shared zone use the **same zone name**.

### Dashboard push failed (HA YAML Lovelace mode)

If you see "HA may be in YAML Lovelace mode", your Lovelace is configured via
`lovelace:` in `configuration.yaml`. Switch to storage mode or paste
`dashboard.yaml` manually via the Raw configuration editor.

### Blueprint not appearing in HA

1. File must be in `/config/blueprints/automation/frigate_identity/`
   (re-run with `--copy-blueprints` or copy manually)
2. No HA restart needed â€” blueprints are hot-loaded
3. Check for YAML syntax errors: **Developer Tools â†’ Template** â†’ paste the
   blueprint YAML to check for errors
